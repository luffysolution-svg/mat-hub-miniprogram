<wxs src="./filter-panel.wxs" module="utils" />
<view class="filter-mask {{visible ? 'show' : ''}}" bindtap="onClose">
  <view class="filter-panel {{visible ? 'show' : ''}}" catchtap="preventBubble">
    <view class="panel-header">
      <text class="panel-title">Filters</text>
      <view class="close-btn" bindtap="onClose">
        <text class="close-icon-text">✕</text>
      </view>
    </view>

    <scroll-view class="panel-content" scroll-y>
      <!-- Type Toggle -->
      <view class="section">
        <text class="section-title">Type</text>
        <view class="toggle-group">
          <view
            wx:for="{{types}}"
            wx:key="id"
            class="toggle-item {{queryType === item.id ? 'active' : ''}}"
            data-type="{{item.id}}"
            bindtap="onTypeChange"
          >
            {{item.name}}
          </view>
        </view>
      </view>

      <!-- Sort -->
      <view class="section">
        <text class="section-title">Sort By</text>
        <view class="toggle-group">
          <view
            wx:for="{{sorts}}"
            wx:key="id"
            class="toggle-item {{sortBy === item.id ? 'active' : ''}}"
            data-sort="{{item.id}}"
            bindtap="onSortChange"
          >
            {{item.name}}
          </view>
        </view>
      </view>

      <!-- Material Sources -->
      <view class="section" wx:if="{{queryType !== 'literature'}}">
        <text class="section-title">Material Sources</text>
        <view class="source-grid">
          <view
            wx:for="{{materialSources}}"
            wx:key="id"
            class="source-chip {{utils.isSourceActive(selectedSources, item.id) ? 'active' : ''}}"
            data-source="{{item.id}}"
            bindtap="onSourceToggle"
          >
            {{item.short}}
          </view>
        </view>
      </view>

      <!-- Literature Sources -->
      <view class="section" wx:if="{{queryType !== 'material'}}">
        <text class="section-title">Literature Sources</text>
        <view class="source-grid">
          <view
            wx:for="{{literatureSources}}"
            wx:key="id"
            class="source-chip {{utils.isSourceActive(selectedSources, item.id) ? 'active' : ''}}"
            data-source="{{item.id}}"
            bindtap="onSourceToggle"
          >
            {{item.short}}
          </view>
        </view>
      </view>

      <!-- Material Filters -->
      <view class="section" wx:if="{{queryType === 'material' || queryType === 'all'}}">
        <text class="section-title">Material Filters</text>
        <view class="filter-row">
          <text class="filter-label">Band Gap (eV)</text>
          <view class="filter-inputs">
            <input
              class="filter-input"
              type="digit"
              placeholder="Min"
              value="{{filters.band_gap_min}}"
              data-field="band_gap_min"
              bindinput="onFilterInput"
            />
            <text class="filter-dash">-</text>
            <input
              class="filter-input"
              type="digit"
              placeholder="Max"
              value="{{filters.band_gap_max}}"
              data-field="band_gap_max"
              bindinput="onFilterInput"
            />
          </view>
        </view>
        <view class="filter-row">
          <text class="filter-label">Min Density (g/cm³)</text>
          <input
            class="filter-input single"
            type="digit"
            placeholder="e.g. 2.0"
            value="{{filters.density_min}}"
            data-field="density_min"
            bindinput="onFilterInput"
          />
        </view>
        <view class="filter-row">
          <text class="filter-label">Max E Above Hull (eV)</text>
          <input
            class="filter-input single"
            type="digit"
            placeholder="e.g. 0.1"
            value="{{filters.e_above_hull_max}}"
            data-field="e_above_hull_max"
            bindinput="onFilterInput"
          />
        </view>
      </view>

      <!-- Literature Filters -->
      <view class="section" wx:if="{{queryType === 'literature' || queryType === 'all'}}">
        <text class="section-title">Literature Filters</text>
        <view class="filter-row">
          <text class="filter-label">Year Range</text>
          <view class="filter-inputs">
            <input
              class="filter-input"
              type="number"
              placeholder="From"
              value="{{filters.year_min}}"
              data-field="year_min"
              bindinput="onFilterInput"
            />
            <text class="filter-dash">-</text>
            <input
              class="filter-input"
              type="number"
              placeholder="To"
              value="{{filters.year_max}}"
              data-field="year_max"
              bindinput="onFilterInput"
            />
          </view>
        </view>
        <view class="filter-row">
          <text class="filter-label">PDF Available</text>
          <view class="toggle-group small">
            <view
              class="toggle-item {{filters.has_pdf === true ? 'active' : ''}}"
              bindtap="onHasPdfChange"
            >
              {{filters.has_pdf === true ? 'Yes' : (filters.has_pdf === false ? 'No' : 'Any')}}
            </view>
          </view>
        </view>
      </view>
    </scroll-view>

    <view class="panel-footer">
      <button class="btn btn-secondary" bindtap="onReset">Reset</button>
      <button class="btn btn-primary" bindtap="onApply">Apply</button>
    </view>
  </view>
</view>
