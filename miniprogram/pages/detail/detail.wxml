<wxs src="../../utils/filters.wxs" module="filters" />
<view class="container">
  <!-- Loading -->
  <skeleton type="detail" wx:if="{{loading}}" />

  <!-- Content -->
  <block wx:if="{{!loading && detail}}">
    <!-- Header -->
    <view class="detail-header">
      <view class="detail-tags">
        <text class="tag tag-{{detail.type}}">
          {{detail.type === 'material' ? 'Material' : 'Literature'}}
        </text>
        <text class="tag tag-source">{{source}}</text>
        <text class="tag tag-success" wx:if="{{(preview && preview.pdf_url) || detail.pdf_url}}">PDF</text>
      </view>
      <view class="header-actions">
        <view class="action-btn" bindtap="toggleFavorite">
          <text class="action-icon-text">{{isFavorite ? '‚òÖ' : '‚òÜ'}}</text>
        </view>
        <button class="action-btn" open-type="share">
          <text class="action-icon-text">‚Üó</text>
        </button>
      </view>
    </view>

    <!-- Title -->
    <text class="detail-title">{{detail.title}}</text>

    <!-- Meta Info -->
    <view class="detail-meta" wx:if="{{detail.authors || detail.journal || detail.year}}">
      <view class="meta-row" wx:if="{{detail.authors && detail.authors.length > 0}}">
        <text class="meta-label">Authors</text>
        <text class="meta-value">{{filters.join(detail.authors, ', ')}}</text>
      </view>
      <view class="meta-row" wx:if="{{detail.journal}}">
        <text class="meta-label">Journal</text>
        <text class="meta-value highlight">{{detail.journal}}</text>
      </view>
      <view class="meta-row" wx:if="{{detail.year}}">
        <text class="meta-label">Year</text>
        <text class="meta-value">{{detail.year}}</text>
      </view>
      <view class="meta-row" wx:if="{{detail.citation_count != null}}">
        <text class="meta-label">Citations</text>
        <text class="meta-value">{{detail.citation_count}}</text>
      </view>
      <view class="meta-row" wx:if="{{detail.doi}}" bindtap="copyDoi">
        <text class="meta-label">DOI</text>
        <text class="meta-value doi">{{detail.doi}}</text>
        <text class="copy-icon-text">üìã</text>
      </view>
    </view>

    <!-- Properties (Material - Materials Project) -->
    <view class="detail-section" wx:if="{{detail.type === 'material' && source === 'materials_project' && detail.properties}}">
      <text class="section-title">Properties</text>
      <view class="properties-grid">
        <!-- Electronic Properties -->
        <view class="property-card" wx:if="{{detail.properties.band_gap != null}}">
          <text class="property-value">{{filters.formatNumber(detail.properties.band_gap, 3)}} eV</text>
          <text class="property-label">Band Gap {{detail.properties.is_gap_direct ? '(Direct)' : '(Indirect)'}}</text>
        </view>
        <view class="property-card" wx:if="{{detail.properties.efermi != null}}">
          <text class="property-value">{{filters.formatNumber(detail.properties.efermi, 3)}} eV</text>
          <text class="property-label">Fermi Energy</text>
        </view>
        <view class="property-card" wx:if="{{detail.properties.total_magnetization != null}}">
          <text class="property-value">{{filters.formatNumber(detail.properties.total_magnetization, 2)}} ŒºB</text>
          <text class="property-label">Magnetization</text>
        </view>

        <!-- Thermodynamic Properties -->
        <view class="property-card" wx:if="{{detail.properties.formation_energy != null}}">
          <text class="property-value">{{filters.formatNumber(detail.properties.formation_energy, 3)}} eV/atom</text>
          <text class="property-label">Formation Energy</text>
        </view>
        <view class="property-card" wx:if="{{detail.properties.e_above_hull != null}}">
          <text class="property-value">{{filters.formatSci(detail.properties.e_above_hull, 2)}} eV</text>
          <text class="property-label">E Above Hull</text>
        </view>

        <!-- Structural Properties -->
        <view class="property-card" wx:if="{{detail.properties.density != null}}">
          <text class="property-value">{{filters.formatNumber(detail.properties.density, 2)}} g/cm¬≥</text>
          <text class="property-label">Density</text>
        </view>
        <view class="property-card" wx:if="{{detail.properties.volume != null}}">
          <text class="property-value">{{filters.formatNumber(detail.properties.volume, 2)}} ≈≥</text>
          <text class="property-label">Volume</text>
        </view>
        <view class="property-card" wx:if="{{detail.properties.nsites != null}}">
          <text class="property-value">{{detail.properties.nsites}}</text>
          <text class="property-label">Atoms in Cell</text>
        </view>

        <!-- Symmetry -->
        <view class="property-card" wx:if="{{detail.properties.symmetry}}">
          <text class="property-value">{{detail.properties.symmetry}}</text>
          <text class="property-label">Space Group</text>
        </view>
        <view class="property-card" wx:if="{{detail.properties.crystal_system}}">
          <text class="property-value">{{detail.properties.crystal_system}}</text>
          <text class="property-label">Crystal System</text>
        </view>

        <!-- Composition -->
        <view class="property-card wide" wx:if="{{detail.properties.elements && detail.properties.elements.length > 0}}">
          <text class="property-value">{{filters.join(detail.properties.elements, ', ')}}</text>
          <text class="property-label">Elements ({{detail.properties.nelements}})</text>
        </view>
      </view>

      <!-- Data Availability -->
      <view class="data-badges" wx:if="{{detail.properties.bandstructure_meta}}">
        <text class="data-badge available" wx:if="{{detail.properties.bandstructure_meta.has_bandstructure}}">Band Structure ‚úì</text>
        <text class="data-badge available" wx:if="{{detail.properties.bandstructure_meta.has_dos}}">DOS ‚úì</text>
        <text class="data-badge theoretical" wx:if="{{detail.properties.theoretical}}">Theoretical</text>
      </view>
    </view>

    <!-- Properties (PubChem) -->
    <view class="detail-section" wx:if="{{detail.type === 'material' && source === 'pubchem' && detail.properties}}">
      <text class="section-title">Properties</text>

      <!-- Molecule Image -->
      <view class="molecule-image-container" wx:if="{{detail.properties.png_link}}">
        <image
          class="molecule-image"
          src="{{detail.properties.png_link}}"
          mode="aspectFit"
          show-menu-by-longpress="{{true}}"
          bindtap="previewMoleculeImage"
        />
      </view>

      <view class="properties-grid">
        <!-- Basic Info -->
        <view class="property-card" wx:if="{{detail.properties.formula}}">
          <text class="property-value">{{detail.properties.formula}}</text>
          <text class="property-label">Molecular Formula</text>
        </view>
        <view class="property-card" wx:if="{{detail.properties.molecular_weight}}">
          <text class="property-value">{{detail.properties.molecular_weight}}</text>
          <text class="property-label">Molecular Weight</text>
        </view>
        <view class="property-card" wx:if="{{detail.properties.exact_mass}}">
          <text class="property-value">{{detail.properties.exact_mass}}</text>
          <text class="property-label">Exact Mass</text>
        </view>
        <view class="property-card" wx:if="{{detail.properties.charge != null}}">
          <text class="property-value">{{detail.properties.charge}}</text>
          <text class="property-label">Charge</text>
        </view>

        <!-- Physical Properties -->
        <view class="property-card" wx:if="{{detail.properties.xlogp != null}}">
          <text class="property-value">{{detail.properties.xlogp}}</text>
          <text class="property-label">XLogP</text>
        </view>
        <view class="property-card" wx:if="{{detail.properties.tpsa != null}}">
          <text class="property-value">{{detail.properties.tpsa}} √Ö¬≤</text>
          <text class="property-label">TPSA</text>
        </view>
        <view class="property-card" wx:if="{{detail.properties.h_bond_donor != null}}">
          <text class="property-value">{{detail.properties.h_bond_donor}}</text>
          <text class="property-label">H-Bond Donors</text>
        </view>
        <view class="property-card" wx:if="{{detail.properties.h_bond_acceptor != null}}">
          <text class="property-value">{{detail.properties.h_bond_acceptor}}</text>
          <text class="property-label">H-Bond Acceptors</text>
        </view>
        <view class="property-card" wx:if="{{detail.properties.rotatable_bonds != null}}">
          <text class="property-value">{{detail.properties.rotatable_bonds}}</text>
          <text class="property-label">Rotatable Bonds</text>
        </view>
        <view class="property-card" wx:if="{{detail.properties.heavy_atom_count != null}}">
          <text class="property-value">{{detail.properties.heavy_atom_count}}</text>
          <text class="property-label">Heavy Atoms</text>
        </view>

        <!-- Identifiers -->
        <view class="property-card wide" wx:if="{{detail.properties.inchi_key}}">
          <text class="property-value small">{{detail.properties.inchi_key}}</text>
          <text class="property-label">InChI Key</text>
        </view>
        <view class="property-card wide" wx:if="{{detail.properties.canonical_smiles}}">
          <text class="property-value small">{{detail.properties.canonical_smiles}}</text>
          <text class="property-label">SMILES</text>
        </view>
      </view>

      <!-- External Links -->
      <view class="external-links" wx:if="{{detail.properties.sdf_link || detail.properties.mol_link}}">
        <text class="subsection-title">Download</text>
        <view class="links-row">
          <text class="link-btn" wx:if="{{detail.properties.sdf_link}}" bindtap="copyLink" data-link="{{detail.properties.sdf_link}}" data-name="SDF">SDF File</text>
          <text class="link-btn" wx:if="{{detail.properties.mol_link}}" bindtap="copyLink" data-link="{{detail.properties.mol_link}}" data-name="MOL">MOL File</text>
        </view>
      </view>
    </view>

    <!-- Properties (CAS Common Chemistry) -->
    <view class="detail-section" wx:if="{{detail.type === 'material' && source === 'cas_common' && detail.properties}}">
      <text class="section-title">Properties</text>

      <view class="properties-grid">
        <!-- Basic Info -->
        <view class="property-card" wx:if="{{detail.properties.cas_rn}}">
          <text class="property-value">{{detail.properties.cas_rn}}</text>
          <text class="property-label">CAS RN</text>
        </view>
        <view class="property-card" wx:if="{{detail.properties.mf}}">
          <rich-text class="property-value" nodes="{{detail.properties.mf}}"></rich-text>
          <text class="property-label">Molecular Formula</text>
        </view>
        <view class="property-card" wx:if="{{detail.properties.molecular_mass}}">
          <text class="property-value">{{detail.properties.molecular_mass}}</text>
          <text class="property-label">Molecular Mass</text>
        </view>

        <!-- Identifiers -->
        <view class="property-card wide" wx:if="{{detail.properties.inchikey}}">
          <text class="property-value small">{{detail.properties.inchikey}}</text>
          <text class="property-label">InChI Key</text>
        </view>
        <view class="property-card wide" wx:if="{{detail.properties.smiles}}">
          <text class="property-value small">{{detail.properties.smiles}}</text>
          <text class="property-label">SMILES</text>
        </view>
      </view>

      <!-- Experimental Properties -->
      <view class="experimental-props" wx:if="{{detail.properties.experimental_properties && detail.properties.experimental_properties.length > 0}}">
        <text class="subsection-title">Experimental Properties</text>
        <view class="exp-props-list">
          <view class="exp-prop-item" wx:for="{{detail.properties.experimental_properties}}" wx:key="name">
            <text class="exp-prop-name">{{item.name}}</text>
            <text class="exp-prop-value">{{item.property}}</text>
          </view>
        </view>
      </view>

      <!-- Synonyms -->
      <view class="synonyms-section" wx:if="{{detail.properties.synonyms && detail.properties.synonyms.length > 0}}">
        <text class="subsection-title">Synonyms</text>
        <view class="synonyms-list">
          <text class="synonym-item" wx:for="{{detail.properties.synonyms}}" wx:key="*this" wx:if="{{index < 10}}">{{item}}</text>
          <text class="synonym-more" wx:if="{{detail.properties.synonyms.length > 10}}">+{{detail.properties.synonyms.length - 10}} more</text>
        </view>
      </view>
    </view>

    <!-- Crystal Structure Section (Material) -->
    <view class="detail-section" wx:if="{{detail.type === 'material' && source === 'materials_project'}}">
      <view class="section-header">
        <text class="section-title">Crystal Structure</text>
        <view class="section-actions">
          <text class="action-link" bindtap="downloadCif">Download CIF</text>
          <text class="action-link" bindtap="openViewer">3D Viewer</text>
        </view>
      </view>

      <!-- Structure Image -->
      <view class="structure-image-container">
        <image
          wx:if="{{structureImageUrl}}"
          class="structure-image"
          src="{{structureImageUrl}}"
          mode="aspectFit"
          show-menu-by-longpress="{{true}}"
          bindtap="previewStructureImage"
          binderror="onStructureImageError"
          bindload="onStructureImageLoad"
        />
        <view class="structure-loading" wx:if="{{loadingStructure}}">
          <view class="loading-spinner"></view>
          <text class="loading-text">Loading structure...</text>
        </view>
        <view class="structure-error" wx:if="{{structureError}}">
          <text>Unable to load structure image</text>
          <text class="retry-link" bindtap="loadStructureImage">Retry</text>
        </view>
      </view>

      <!-- Lattice Parameters -->
      <view class="lattice-params" wx:if="{{structureInfo && structureInfo.lattice}}">
        <text class="subsection-title">Lattice Parameters</text>
        <view class="lattice-grid">
          <view class="lattice-item">
            <text class="lattice-label">a</text>
            <text class="lattice-value">{{structureInfo.lattice.a}} √Ö</text>
          </view>
          <view class="lattice-item">
            <text class="lattice-label">b</text>
            <text class="lattice-value">{{structureInfo.lattice.b}} √Ö</text>
          </view>
          <view class="lattice-item">
            <text class="lattice-label">c</text>
            <text class="lattice-value">{{structureInfo.lattice.c}} √Ö</text>
          </view>
          <view class="lattice-item">
            <text class="lattice-label">Œ±</text>
            <text class="lattice-value">{{structureInfo.lattice.alpha}}¬∞</text>
          </view>
          <view class="lattice-item">
            <text class="lattice-label">Œ≤</text>
            <text class="lattice-value">{{structureInfo.lattice.beta}}¬∞</text>
          </view>
          <view class="lattice-item">
            <text class="lattice-label">Œ≥</text>
            <text class="lattice-value">{{structureInfo.lattice.gamma}}¬∞</text>
          </view>
        </view>
      </view>

      <!-- Atom Sites Summary -->
      <view class="atom-sites" wx:if="{{structureInfo && structureInfo.sites.length > 0}}">
        <text class="subsection-title">Atomic Sites ({{structureInfo.nsites}})</text>
        <scroll-view class="sites-list" scroll-y style="max-height: 300rpx;">
          <view class="site-item" wx:for="{{structureInfo.sites}}" wx:key="index" wx:if="{{index < 10}}">
            <text class="site-species">{{item.species}}</text>
            <text class="site-coords">({{item.coords[0]}}, {{item.coords[1]}}, {{item.coords[2]}})</text>
          </view>
          <view class="site-more" wx:if="{{structureInfo.sites.length > 10}}">
            <text>... and {{structureInfo.sites.length - 10}} more sites</text>
          </view>
        </scroll-view>
      </view>
    </view>

    <!-- Electronic Structure Section (Material with BS/DOS) -->
    <view class="detail-section" wx:if="{{detail.type === 'material' && source === 'materials_project' && detail.properties.bandstructure_meta}}">
      <text class="section-title">Electronic Structure</text>

      <!-- Band Structure -->
      <view class="electronic-card" wx:if="{{detail.properties.bandstructure_meta.has_bandstructure}}">
        <text class="subsection-title">Band Structure</text>
        <view class="electronic-image-container">
          <image
            wx:if="{{bandstructureImageUrl}}"
            class="electronic-image"
            src="{{bandstructureImageUrl}}"
            mode="aspectFit"
            show-menu-by-longpress="{{true}}"
            bindtap="previewBandstructure"
            binderror="onBandstructureError"
          />
          <view class="electronic-placeholder" wx:if="{{!bandstructureImageUrl}}">
            <text class="placeholder-text" bindtap="loadBandstructure">Tap to load band structure</text>
          </view>
        </view>
      </view>

      <!-- DOS -->
      <view class="electronic-card" wx:if="{{detail.properties.bandstructure_meta.has_dos}}">
        <text class="subsection-title">Density of States</text>
        <view class="electronic-image-container">
          <image
            wx:if="{{dosImageUrl}}"
            class="electronic-image"
            src="{{dosImageUrl}}"
            mode="aspectFit"
            show-menu-by-longpress="{{true}}"
            bindtap="previewDos"
            binderror="onDosError"
          />
          <view class="electronic-placeholder" wx:if="{{!dosImageUrl}}">
            <text class="placeholder-text" bindtap="loadDos">Tap to load DOS</text>
          </view>
        </view>
      </view>
    </view>

    <!-- Similar Materials Section -->
    <view class="detail-section" wx:if="{{detail.type === 'material' && similarMaterials.length > 0}}">
      <text class="section-title">Similar Materials</text>
      <scroll-view class="similar-list" scroll-x>
        <view class="similar-item" wx:for="{{similarMaterials}}" wx:key="id" bindtap="goToSimilar" data-item="{{item}}">
          <text class="similar-formula">{{item.formula}}</text>
          <text class="similar-prop" wx:if="{{item.band_gap != null}}">Eg: {{item.band_gap}} eV</text>
          <text class="similar-id">{{item.id}}</text>
        </view>
      </scroll-view>
    </view>

    <!-- Abstract -->
    <view class="detail-section" wx:if="{{detail.abstract}}">
      <text class="section-title">Abstract</text>
      <!-- Ê£ÄÊµãÊòØÂê¶‰∏∫ÈîôËØØ/ÂõûÈÄÄ‰ø°ÊÅØ -->
      <view wx:if="{{detail.properties && detail.properties.error}}" class="api-error-notice">
        <text class="error-icon">‚ö†Ô∏è</text>
        <text class="error-text">{{detail.abstract}}</text>
        <text class="error-hint">PDF ÈìæÊé•‰ªçÂèØ‰ΩøÁî®</text>
      </view>
      <text wx:else class="abstract-text">{{detail.abstract}}</text>
    </view>

    <!-- Actions -->
    <view class="detail-actions">
      <button
        class="btn btn-secondary"
        wx:if="{{(preview && preview.pdf_url) || detail.pdf_url}}"
        bindtap="openPdf"
      >
        <text class="btn-icon-text">{{source === 'arxiv' || source === 'semantic_scholar' || source === 'openalex' ? '‚¨áÔ∏è' : 'üîó'}}</text>
        <text>{{source === 'arxiv' || source === 'semantic_scholar' || source === 'openalex' ? 'Download PDF' : 'View PDF'}}</text>
      </button>
      <button class="btn btn-primary" bindtap="showExportPanel">
        <text class="btn-icon-text">üì§</text>
        <text>Export Citation</text>
      </button>
    </view>

    <!-- References -->
    <view class="detail-section" wx:if="{{detail.type === 'literature'}}">
      <text class="section-title">References</text>
      <view class="loading-container" wx:if="{{loadingRefs}}">
        <view class="loading-spinner"></view>
      </view>
      <view class="references-list" wx:elif="{{references.length > 0}}">
        <view class="reference-item" wx:for="{{references}}" wx:key="index">
          <text class="ref-number">{{index + 1}}.</text>
          <view class="ref-content">
            <text class="ref-title">{{item.title}}</text>
            <text class="ref-meta" wx:if="{{item.authors || item.year}}">
              {{item.authors ? filters.sliceJoin(item.authors, 0, 2, ', ') : ''}}
              {{item.year ? '(' + item.year + ')' : ''}}
            </text>
          </view>
        </view>
      </view>
      <view class="empty-refs" wx:else>
        <text>No references available</text>
      </view>
    </view>
  </block>

  <!-- Error State -->
  <empty
    wx:if="{{!loading && !detail}}"
    type="error"
    showAction="{{true}}"
    bind:action="loadDetail"
  />

  <!-- Export Panel -->
  <view class="export-mask {{showExport ? 'show' : ''}}" bindtap="hideExportPanel">
    <view class="export-panel {{showExport ? 'show' : ''}}" catchtap="">
      <view class="export-header">
        <text class="export-title">Export Citation</text>
        <view class="close-btn" bindtap="hideExportPanel">
          <text class="close-icon-text">‚úï</text>
        </view>
      </view>

      <view class="format-tabs">
        <view
          wx:for="{{exportFormats}}"
          wx:key="id"
          class="format-tab {{selectedFormat === item.id ? 'active' : ''}}"
          data-format="{{item.id}}"
          bindtap="onFormatChange"
        >
          {{item.name}}
        </view>
      </view>

      <view class="export-content">
        <view class="loading-container" wx:if="{{loadingExport}}">
          <view class="loading-spinner"></view>
        </view>
        <scroll-view class="citation-text" scroll-y wx:else>
          <text selectable>{{exportContent || 'No citation available'}}</text>
        </scroll-view>
      </view>

      <button class="btn btn-primary export-copy-btn" bindtap="copyExport">
        Copy to Clipboard
      </button>
    </view>
  </view>
</view>
