<!--pages/tools/tools.wxml-->
<wxs src="./tools.wxs" module="utils" />

<view class="container">
  <!-- Tab åˆ‡æ¢ -->
  <view class="tab-bar">
    <view
      class="tab-item {{activeTab === 'periodic' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="periodic"
    >
      <text class="tab-text">å…ƒç´ å‘¨æœŸè¡¨</text>
    </view>
    <view
      class="tab-item {{activeTab === 'calculator' ? 'active' : ''}}"
      bindtap="switchTab"
      data-tab="calculator"
    >
      <text class="tab-text">åˆ†å­è´¨é‡è®¡ç®—</text>
    </view>
  </view>

  <!-- å…ƒç´ å‘¨æœŸè¡¨ Tab -->
  <view class="tab-content" wx:if="{{activeTab === 'periodic'}}">
    <!-- åˆ†ç±»ç­›é€‰ -->
    <scroll-view class="category-scroll" scroll-x enable-flex>
      <view class="category-list">
        <view
          class="category-chip {{selectedCategory === '' ? 'active' : ''}}"
          bindtap="selectCategory"
          data-category=""
        >
          å…¨éƒ¨
        </view>
        <view
          wx:for="{{categories}}"
          wx:key="id"
          class="category-chip {{selectedCategory === item.id ? 'active' : ''}}"
          style="--chip-color: {{item.color}}"
          bindtap="selectCategory"
          data-category="{{item.id}}"
        >
          {{item.name}} ({{item.count}})
        </view>
      </view>
    </scroll-view>

    <!-- æœç´¢æ¡† -->
    <view class="search-box">
      <input
        class="search-input"
        placeholder="æœç´¢å…ƒç´ åç§°ã€ç¬¦å·æˆ–åŸå­åºæ•°"
        value="{{searchQuery}}"
        bindinput="onSearchInput"
        confirm-type="search"
        bindconfirm="doSearch"
      />
      <view class="search-icon" bindtap="doSearch">
        <text>ğŸ”</text>
      </view>
    </view>

    <!-- å…ƒç´ å‘¨æœŸè¡¨ç½‘æ ¼ -->
    <scroll-view class="periodic-table-scroll" scroll-x wx:if="{{!searchQuery && !selectedCategory}}">
      <view class="periodic-table">
        <!-- ä¸»è¡¨æ ¼ - 7è¡Œ18åˆ— -->
        <view class="pt-row" wx:for="{{[1,2,3,4,5,6,7]}}" wx:for-item="period" wx:key="*this">
          <view
            wx:for="{{[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]}}"
            wx:for-item="group"
            wx:key="*this"
            class="pt-cell {{utils.getElementAtPosition(elementPositionMap, period, group) ? 'has-element' : 'empty'}}"
            style="{{utils.getElementAtPosition(elementPositionMap, period, group) ? 'background-color:' + utils.getElementColor(utils.getElementAtPosition(elementPositionMap, period, group).category) : ''}}"
            bindtap="onCellTap"
            data-period="{{period}}"
            data-group="{{group}}"
          >
            <block wx:if="{{utils.getElementAtPosition(elementPositionMap, period, group)}}">
              <text class="el-number">{{utils.getElementAtPosition(elementPositionMap, period, group).number}}</text>
              <text class="el-symbol">{{utils.getElementAtPosition(elementPositionMap, period, group).symbol}}</text>
            </block>
          </view>
        </view>

        <!-- é•§ç³»å’Œé”•ç³»åˆ†éš” -->
        <view class="pt-separator"></view>

        <!-- é•§ç³» (57-71) -->
        <view class="pt-row lanthanides">
          <view class="pt-label">é•§ç³»</view>
          <view
            wx:for="{{lanthanides}}"
            wx:key="symbol"
            class="pt-cell has-element"
            style="background-color: {{utils.getElementColor(item.category)}}"
            bindtap="showElementDetail"
            data-element="{{item}}"
          >
            <text class="el-number">{{item.number}}</text>
            <text class="el-symbol">{{item.symbol}}</text>
          </view>
        </view>

        <!-- é”•ç³» (89-103) -->
        <view class="pt-row actinides">
          <view class="pt-label">é”•ç³»</view>
          <view
            wx:for="{{actinides}}"
            wx:key="symbol"
            class="pt-cell has-element"
            style="background-color: {{utils.getElementColor(item.category)}}"
            bindtap="showElementDetail"
            data-element="{{item}}"
          >
            <text class="el-number">{{item.number}}</text>
            <text class="el-symbol">{{item.symbol}}</text>
          </view>
        </view>
      </view>
    </scroll-view>

    <!-- æœç´¢/ç­›é€‰ç»“æœåˆ—è¡¨ -->
    <view class="elements-list" wx:if="{{searchQuery || selectedCategory}}">
      <view class="result-count">
        æ‰¾åˆ° {{filteredElements.length}} ä¸ªå…ƒç´ 
      </view>
      <view
        wx:for="{{filteredElements}}"
        wx:key="symbol"
        class="element-card"
        bindtap="showElementDetail"
        data-element="{{item}}"
      >
        <view class="element-card-left" style="background-color: {{utils.getElementColor(item.category)}}">
          <text class="card-number">{{item.number}}</text>
          <text class="card-symbol">{{item.symbol}}</text>
        </view>
        <view class="element-card-right">
          <view class="card-name">{{item.name_zh}} / {{item.name}}</view>
          <view class="card-info">
            <text class="card-mass">{{item.atomic_mass}} u</text>
            <text class="card-category" style="color: {{utils.getElementColor(item.category)}}">{{item.category_zh}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- åˆ†å­è´¨é‡è®¡ç®—å™¨ Tab -->
  <view class="tab-content" wx:if="{{activeTab === 'calculator'}}">
    <view class="calc-section">
      <view class="section-title">è¾“å…¥åŒ–å­¦å¼</view>
      <view class="formula-input-box">
        <input
          class="formula-input"
          placeholder="ä¾‹å¦‚: H2O, CaCO3, CuSO4Â·5H2O"
          value="{{formula}}"
          bindinput="onFormulaInput"
          confirm-type="done"
          bindconfirm="calculateMolarMass"
        />
        <button class="calc-btn" bindtap="calculateMolarMass">è®¡ç®—</button>
      </view>
      <view class="formula-tips">
        <text class="tip-title">æ”¯æŒæ ¼å¼:</text>
        <text class="tip-item">â€¢ åŸºæœ¬åŒ–å­¦å¼: H2O, NaCl, C6H12O6</text>
        <text class="tip-item">â€¢ å¸¦æ‹¬å·: Ca(OH)2, Mg3(PO4)2</text>
        <text class="tip-item">â€¢ ç»“æ™¶æ°´: CuSO4Â·5H2O (ç”¨ Â· æˆ– . åˆ†éš”)</text>
      </view>
    </view>

    <!-- è®¡ç®—ç»“æœ -->
    <view class="calc-result" wx:if="{{calcResult}}">
      <view class="result-header">
        <text class="result-formula">{{calcResult.formula}}</text>
        <text class="result-mass">{{calcResult.molar_mass_formatted}}</text>
      </view>

      <view class="result-detail">
        <view class="detail-title">å…ƒç´ ç»„æˆ</view>
        <view class="composition-table">
          <view class="table-header">
            <text class="col-symbol">å…ƒç´ </text>
            <text class="col-count">æ•°é‡</text>
            <text class="col-mass">åŸå­é‡</text>
            <text class="col-total">å°è®¡</text>
          </view>
          <view
            wx:for="{{calcResult.components}}"
            wx:key="symbol"
            class="table-row"
          >
            <text class="col-symbol">{{item.symbol}} ({{item.name_zh}})</text>
            <text class="col-count">{{item.count}}</text>
            <text class="col-mass">{{item.atomic_mass}}</text>
            <text class="col-total">{{item.subtotal_mass}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- è®¡ç®—å†å² -->
    <view class="calc-history" wx:if="{{calcHistory.length > 0}}">
      <view class="history-header">
        <text class="history-title">è®¡ç®—å†å²</text>
        <text class="history-clear" bindtap="clearHistory">æ¸…ç©º</text>
      </view>
      <view class="history-list">
        <view
          wx:for="{{calcHistory}}"
          wx:key="index"
          class="history-item"
          bindtap="useHistoryFormula"
          data-formula="{{item.formula}}"
        >
          <text class="history-formula">{{item.formula}}</text>
          <text class="history-mass">{{item.molar_mass_formatted}}</text>
        </view>
      </view>
    </view>

    <!-- å¸¸ç”¨åŒ–å­¦å¼å¿«æ·æŒ‰é’® -->
    <view class="quick-formulas">
      <view class="section-title">å¸¸ç”¨åŒ–å­¦å¼</view>
      <view class="quick-list">
        <view
          wx:for="{{quickFormulas}}"
          wx:key="formula"
          class="quick-item"
          bindtap="useQuickFormula"
          data-formula="{{item.formula}}"
        >
          <text class="quick-formula">{{item.formula}}</text>
          <text class="quick-name">{{item.name}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- å…ƒç´ è¯¦æƒ…å¼¹çª— -->
  <view class="element-modal" wx:if="{{showModal}}" bindtap="closeModal">
    <view class="modal-content" catchtap="">
      <view class="modal-header" style="background-color: {{utils.getElementColor(selectedElement.category)}}">
        <view class="modal-number">{{selectedElement.number}}</view>
        <view class="modal-symbol">{{selectedElement.symbol}}</view>
        <view class="modal-name">{{selectedElement.name_zh}} / {{selectedElement.name}}</view>
        <view class="modal-mass">{{selectedElement.atomic_mass}} u</view>
      </view>
      <view class="modal-body">
        <view class="info-row">
          <text class="info-label">åˆ†ç±»</text>
          <text class="info-value" style="color: {{utils.getElementColor(selectedElement.category)}}">{{selectedElement.category_zh}}</text>
        </view>
        <view class="info-row">
          <text class="info-label">å‘¨æœŸ / æ—</text>
          <text class="info-value">ç¬¬{{selectedElement.period}}å‘¨æœŸ / ç¬¬{{selectedElement.group || '-'}}æ—</text>
        </view>
        <view class="info-row">
          <text class="info-label">åŒºå—</text>
          <text class="info-value">{{selectedElement.block}}åŒº</text>
        </view>
        <view class="info-row">
          <text class="info-label">ç”µå­æ’å¸ƒ</text>
          <text class="info-value">{{selectedElement.electron_configuration}}</text>
        </view>
        <view class="info-row" wx:if="{{selectedElement.electronegativity}}">
          <text class="info-label">ç”µè´Ÿæ€§</text>
          <text class="info-value">{{selectedElement.electronegativity}}</text>
        </view>
        <view class="info-row" wx:if="{{selectedElement.density}}">
          <text class="info-label">å¯†åº¦</text>
          <text class="info-value">{{selectedElement.density}} g/cmÂ³</text>
        </view>
        <view class="info-row" wx:if="{{selectedElement.melt}}">
          <text class="info-label">ç†”ç‚¹</text>
          <text class="info-value">{{selectedElement.melt}} K</text>
        </view>
        <view class="info-row" wx:if="{{selectedElement.boil}}">
          <text class="info-label">æ²¸ç‚¹</text>
          <text class="info-value">{{selectedElement.boil}} K</text>
        </view>
        <view class="info-row">
          <text class="info-label">ç›¸æ€</text>
          <text class="info-value">{{selectedElement.phase}}</text>
        </view>
        <view class="info-summary" wx:if="{{selectedElement.summary}}">
          <text class="summary-title">ç®€ä»‹</text>
          <text class="summary-text">{{selectedElement.summary}}</text>
        </view>
      </view>
      <view class="modal-close" bindtap="closeModal">å…³é—­</view>
    </view>
  </view>
</view>
